<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
        table {
            width: 100%;
            border-spacing: 0;
            border-collapse: initial;
            border: 1px solid black;
            border-right: none;
            border-bottom: none;
        }
        th, td {
            border: 1px solid black;
            border-top: none;
            border-left: none;
            padding: 10px;
            text-align: center;
        }
        select {
            width: 300px;
            height: 40px;
            line-height: 40px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <h2>媒体查询（enumerateDevices）</h2>
    <select id="video-select" placehoder="请选择摄像头">
        
    </select>
    <video id="video" width="100%" height="500px" style="object-fit: cover;"></video>
    <table>
        <thead>
            <tr>
                <th>kind</th>
                <th>label</th>
                <th>mediaId</th>
            </tr>
        </thead>
        <tbody id="video-list">
        </tbody>
    </table>
    <pre id="list-json"></pre>
    <h2>媒体查询（getUserMedia）</h2>
    <pre id="media-info"></pre>
    <script>
        const videoList = document.getElementById('video-list');
        const listJson = document.getElementById('list-json');
        const videoSelect = document.getElementById('video-select');
        const video = document.getElementById('video');
        const infoNode = document.getElementById('media-info');

        const config = {
            aspectRatio: 0.75,
            width: { min: 720, ideal: 1280, max: 1920 },
        }

        navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                let videoListStr = '';
                let optionStr = '';
                let newList = [];
                let i = 1;
                devices.forEach(device => {
                    if (device.kind === 'videoinput') {
                        newList.push(device);
                        videoListStr += `
                            <tr>
                                <td>${device.kind}</td>
                                <td>${device.label}</td>
                                <td>${device.deviceId}</td>
                            </tr>
                        `
                        optionStr += `
                            <option value="${device.deviceId}">${device.label || `摄像头${i}`}</option>
                            `
                        i++
                    }
                })
                videoList.innerHTML = videoListStr;
                videoSelect.innerHTML = optionStr;
                listJson.innerHTML = JSON.stringify(newList, null, 2)
            })

        videoSelect.onchange = function(e) {
            const deviceId = e.target.value;
            const constraints = {
                audio: false,
                video: {
                    deviceId: {
                        exact: deviceId
                    },
                    ...config
                }
            }
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    const track = stream.getVideoTracks();
                    const info = track[0].getSettings();
                    infoNode.innerHTML = JSON.stringify(info, null, 2)
                    video.srcObject = stream;
                    video.play();
                })
        }
        navigator.mediaDevices.getUserMedia({
            audio: false,
            video: config
        }).then((stream) => {
            const track = stream.getVideoTracks();
            const info = track[0].getSettings();
            videoSelect.setAttribute('value', info.deviceId);
            infoNode.innerHTML = JSON.stringify(info, null, 2)
            video.srcObject = stream;
            video.play();
        })

    </script>
</body>
</html>